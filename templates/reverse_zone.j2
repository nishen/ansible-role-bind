; Reverse zone file for {{ item }}
; {{ ansible_managed }}

$TTL {{ bind_zone_ttl }}
$ORIGIN {{ item | reverse_lookup_zone }}.

{% set zone_config_done = False %}
{% for bz in bind_zones %}
{% if not zone_config_done %}
{% if item in bz.bind_zone_networks %}
{% set zone_config_done = True %}

{% if bz.bind_zone_name_servers | length > 0 %}
@ IN SOA {{ bz.bind_zone_name_servers | first }}.{{ bz.bind_zone_name }}. {{ bind_zone_hostmaster_email }}.{{ bz.bind_zone_name }}. (
{% else %}
@ IN SOA {{ ansible_hostname }}.{{ bz.bind_zone_name }}. {{ bind_zone_hostmaster_email }}.{{ bz.bind_zone_name }}. (
{% endif %}
  {{ timestamp.stdout }}
  {{ bind_zone_time_to_refresh }}
  {{ bind_zone_time_to_retry }}
  {{ bind_zone_time_to_expire }}
  {{ bind_zone_minimum_ttl }} )

{% if bz.bind_zone_name_servers | length > 0 %}
{% for ns in bz.bind_zone_name_servers %}
         IN  NS   {{ ns }}.{{ bz.bind_zone_name }}.
{% endfor %}
{% else %}
         IN  NS   {{ ansible_hostname }}.{{ bz.bind_zone_name }}.
{% endif %}
{% if bz.bind_other_name_servers | length > 0 %}
{% for ns in bz.bind_other_name_servers %}
         IN  NS   {{ ns }}.
{% endfor %}
{% endif %}
{% endif %}
{% endif %}
{% endfor %}

{% for bz in bind_zones %}
{% if bz.bind_zone_hosts | length > 0 %}
{% for host in bz.bind_zone_hosts %}
{% if host.ip == item %}
@        IN  PTR  {{ host.name }}.{{ bz.bind_zone_name }}.
{% else %}
{% if host.ip is string and host.ip.startswith(item) %}
{% if host.name == '@' %}
{{ ('.'.join(host.ip.replace(item+'.','').split('.')[::-1])).ljust(8) }} IN  PTR  {{ bz.bind_zone_name }}.
{% else %}
{{ ('.'.join(host.ip.replace(item+'.','').split('.')[::-1])).ljust(8) }} IN  PTR  {{ host.name }}.{{ bz.bind_zone_name }}.
{% endif %}
{% else %}
{% for ip in host.ip %}
{% if ip.startswith(item) %}
{{ ('.'.join(ip.replace(item+'.','').split('.')[::-1])).ljust(8) }} IN  PTR  {{ bz.bind_zone_name }}.
{% if host.name == '@' %}
{% else %}
{{ ('.'.join(ip.replace(item+'.','').split('.')[::-1])).ljust(8) }} IN  PTR  {{ host.name }}.{{ bz.bind_zone_name }}.
{% endif %}
{% endif %}
{% endfor %}
{% endif %}
{% endif %}
{% endfor %}
{% else %}
{{ ('.'.join(ansible_default_ipv4.address.replace(item+'.','').split('.')[::-1])).ljust(8) }} IN  PTR  {{ ansible_hostname }}.{{ bz.bind_zone_name }}.
{% endif %}
{% endfor %}


